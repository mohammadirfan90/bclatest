module.exports=[70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,a)=>{t.exports=e.x("util",()=>require("util"))},14747,(e,t,a)=>{t.exports=e.x("path",()=>require("path"))},93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},54799,(e,t,a)=>{t.exports=e.x("crypto",()=>require("crypto"))},74129,e=>{"use strict";var t=e.i(1265),a=e.i(90727),r=e.i(43793),n=e.i(23076);function c(e,a){return t.NextResponse.json({success:!0,data:e,meta:a},{status:200})}function s(e){return t.NextResponse.json({success:!0,data:e},{status:201})}function o(e,a=400){return t.NextResponse.json({success:!1,error:e},{status:a})}function i(e){return t.NextResponse.json({success:!1,error:"Validation failed",errors:e},{status:400})}function u(e="Unauthorized"){return t.NextResponse.json({success:!1,error:e},{status:401})}function d(e="Forbidden"){return t.NextResponse.json({success:!1,error:e},{status:403})}function l(e="Not found"){return t.NextResponse.json({success:!1,error:e},{status:404})}function p(e="Internal server error"){return t.NextResponse.json({success:!1,error:e},{status:500})}async function _(e,t,n={}){let{requiredType:c="any",requiredRoles:s,requiredPermissions:o,hideFailure:i=!1}=n,p=e=>i?l():e,y=e.headers.get("authorization");if(!y||!y.startsWith("Bearer "))return p(u("No token provided"));let E=y.substring(7),m=(0,a.verifyToken)(E);if(!m)return p(u("Invalid or expired token"));if("any"!==c&&m.type!==c)return p(d(`Access restricted to ${c}s`));if(e.tokenPayload=m,"user"===m.type){let[t]=await (0,r.query)(`SELECT u.id, u.email, u.first_name, u.last_name, u.role_id,
              r.code as role_code, r.name as role_name, r.permissions,
              u.status
       FROM users u
       INNER JOIN roles r ON r.id = u.role_id
       WHERE u.id = ? AND u.status = 'ACTIVE'`,[m.sub]);if(!t)return p(u("User not found or inactive"));let a=[];try{let e=t.permissions;e&&"string"==typeof e&&e.startsWith("[")?a=JSON.parse(e):Array.isArray(e)&&(a=e)}catch(e){console.warn("Invalid permissions JSON, defaulting to empty array"),a=[]}if(e.user={id:t.id,email:t.email,firstName:t.first_name,lastName:t.last_name,roleId:t.role_id,roleCode:t.role_code,roleName:t.role_name,permissions:a,status:t.status,mfaEnabled:!1},s&&s.length>0&&!s.includes(t.role_code))return p(d("Insufficient role privileges"));if(o&&o.length>0&&!o.some(e=>a.includes(e)))return p(d("Insufficient permissions"))}if("customer"===m.type){let[t]=await (0,r.query)(`SELECT id, customer_number, email, status
       FROM customers
       WHERE id = ? AND status = 'ACTIVE'`,[m.sub]);if(!t)return u("Customer not found or inactive");e.customer={id:t.id,customerNumber:t.customer_number,email:t.email}}return t(e)}async function y(e,t){try{let a=await e.json(),r=t.parse(a);return{success:!0,data:r}}catch(e){if(e instanceof n.ZodError)return{success:!1,response:i(e.issues.map(e=>({field:e.path.join("."),message:e.message})))};return{success:!1,response:o("Invalid request body")}}}function E(e,t){try{let a=Object.fromEntries(e.nextUrl.searchParams.entries()),r=t.parse(a);return{success:!0,data:r}}catch(e){if(e instanceof n.ZodError)return{success:!1,response:i(e.issues.map(e=>({field:e.path.join("."),message:e.message})))};return{success:!1,response:o("Invalid query parameters")}}}function m(e){return e.headers.get("Idempotency-Key")||e.headers.get("idempotency-key")||null}async function f(e){if(!e)return{cached:!1};let[a]=await (0,r.query)(`SELECT response_status, response_body
     FROM idempotency_keys
     WHERE idempotency_key = ? AND expires_at > NOW()`,[e]);if(a){let e=JSON.parse(a.response_body);return{cached:!0,response:t.NextResponse.json(e,{status:a.response_status})}}return{cached:!1}}function N(e){return async(t,a)=>{try{return await e(t,a)}catch(e){if(console.error("API Error:",e),e instanceof Error)return p("An unexpected error occurred");return p()}}}function O(e,t,a){return{page:e,limit:t,total:a,totalPages:Math.ceil(a/t)}}function b(e,t){return(e-1)*t}e.s(["checkIdempotency",()=>f,"createdResponse",()=>s,"errorResponse",()=>o,"getIdempotencyKey",()=>m,"getOffset",()=>b,"getPaginationMeta",()=>O,"notFoundResponse",()=>l,"successResponse",()=>c,"validateBody",()=>y,"validateQuery",()=>E,"validationErrorResponse",()=>i,"withAuth",()=>_,"withErrorHandler",()=>N])},31931,e=>{"use strict";var t=e.i(43793);async function a(e){let a=await (0,t.queryOne)(`SELECT a.id, a.account_number, a.customer_id, a.account_type_id,
                at.code as account_type, at.name as account_type_name,
                a.status, a.created_at,
                COALESCE(ab.currency, 'BDT') as currency
         FROM accounts a
         JOIN account_types at ON at.id = a.account_type_id
         LEFT JOIN account_balances ab ON ab.account_id = a.id
         WHERE a.id = ?`,[e]);return a?{id:a.id,accountNumber:a.account_number,customerId:a.customer_id,accountType:a.account_type,currency:a.currency,status:a.status,openedAt:a.created_at,createdAt:a.created_at}:null}async function r(e){let a=await (0,t.queryOne)(`SELECT a.id, a.account_number, a.customer_id, a.account_type_id,
                at.code as account_type, at.name as account_type_name,
                a.status, a.created_at,
                COALESCE(ab.currency, 'BDT') as currency
         FROM accounts a
         JOIN account_types at ON at.id = a.account_type_id
         LEFT JOIN account_balances ab ON ab.account_id = a.id
         WHERE a.account_number = ?`,[e]);return a?{id:a.id,accountNumber:a.account_number,customerId:a.customer_id,accountType:a.account_type,currency:a.currency,status:a.status,openedAt:a.created_at,createdAt:a.created_at}:null}async function n(e){return(await (0,t.query)(`SELECT a.id, a.account_number, a.customer_id, a.account_type_id,
                at.code as account_type, at.name as account_type_name,
                a.status, a.created_at,
                c.first_name, c.last_name,
                COALESCE(ab.available_balance, 0) as available_balance,
                COALESCE(ab.currency, 'BDT') as currency
         FROM accounts a
         JOIN customers c ON c.id = a.customer_id
         JOIN account_types at ON at.id = a.account_type_id
         LEFT JOIN account_balances ab ON ab.account_id = a.id
         WHERE a.customer_id = ?
         ORDER BY a.created_at DESC`,[e])).map(e=>({id:e.id,accountNumber:e.account_number,customerId:e.customer_id,accountType:e.account_type,accountTypeName:e.account_type_name,currency:e.currency,status:e.status,openedAt:e.created_at,createdAt:e.created_at,customerName:`${e.first_name} ${e.last_name}`,balance:{availableBalance:parseFloat(e.available_balance||"0")}}))}async function c(e,a,r){try{return await (0,t.query)('UPDATE accounts SET status = "SUSPENDED", updated_at = NOW() WHERE id = ?',[e]),{success:!0}}catch(e){return console.error("Error freezing account:",e),{success:!1,error:"Failed"}}}async function s(e,a,r){try{return await (0,t.query)('UPDATE accounts SET status = "ACTIVE", updated_at = NOW() WHERE id = ?',[e]),{success:!0}}catch(e){return console.error("Error unfreezing account:",e),{success:!1,error:"Failed"}}}async function o(e,a,r){try{let a=await (0,t.queryOne)("SELECT available_balance FROM account_balances WHERE account_id = ?",[e]),r=parseFloat(a?.available_balance||"0");if(0!==r)return{success:!1,error:`Cannot close account. Non-zero balance: ${r}`};return await (0,t.query)('UPDATE accounts SET status = "CLOSED", updated_at = NOW() WHERE id = ?',[e]),{success:!0}}catch(e){return console.error("Error closing account:",e),{success:!1,error:"Failed"}}}async function i(e,a,r){try{if(!await (0,t.queryOne)("SELECT id FROM customers WHERE id = ?",[e]))return{success:!1,error:"Customer not found"};let n=String(e).padStart(4,"0"),c=String(Math.floor(1e3+9e3*Math.random())),s=`1001-${n}-${c}`;return await (0,t.withTransaction)(async t=>{let[n]=await t.execute(`INSERT INTO accounts (account_number, customer_id, account_type_id, status, opened_at, created_at, created_by)
                 VALUES (?, ?, ?, 'ACTIVE', NOW(), NOW(), ?)`,[s,e,a,r||null]),c=n.insertId;return await t.execute(`INSERT INTO account_balances (account_id, available_balance, currency, version)
                 VALUES (?, 0.0000, 'BDT', 1)`,[c]),{success:!0,accountId:c,accountNumber:s}})}catch(e){return console.error("Error creating account:",e),{success:!1,error:"Database error during account creation"}}}async function u(e,a){let r=await (0,t.queryOne)("SELECT id FROM account_types WHERE code = ?",[a]);if(!r)return{success:!1,error:"Invalid account type"};let n=await i(e,r.id);return n.success?{success:!0,applicationId:n.accountId}:{success:!1,error:n.error}}async function d(a){try{let r="Welcome!"+Math.floor(1e3+9e3*Math.random()),{hashPassword:n}=await e.A(543),c=await n(r),s=await (0,t.execute)(`INSERT INTO customers 
             (customer_number, email, first_name, last_name, date_of_birth, status, kyc_status, created_at, created_by, password_hash)
             VALUES (?, ?, ?, ?, ?, 'ACTIVE', 'VERIFIED', NOW(), ?, ?)`,[a.customerNumber,a.email,a.firstName,a.lastName,a.dateOfBirth,a.createdBy,c]);return{success:!0,customerId:s.insertId,tempPassword:r}}catch(e){if("ER_DUP_ENTRY"===e.code)return{success:!1,error:"Email or Customer Number already exists"};return console.error("Error during customer creation:",e),{success:!1,error:"Database error during customer creation"}}}async function l(e){}e.s(["applyForAccount",()=>u,"closeAccount",()=>o,"createAccount",()=>i,"freezeAccount",()=>c,"getAccountById",()=>a,"getAccountByNumber",()=>r,"getAccountsForCustomer",()=>n,"onboardNewCustomer",()=>d,"refreshAccountBalance",()=>l,"unfreezeAccount",()=>s])},11585,e=>{"use strict";var t=e.i(43793);e.i(1612);var a=e.i(30497),r=e.i(4489),n=e.i(21854);async function c(e,a){let{from:r,to:n,page:c=1,size:s=50}=a,o=(c-1)*s,i=await (0,t.queryOne)(`SELECT a.id, a.account_number, at.name as account_type_name,
                CONCAT(c.first_name, ' ', c.last_name) as customer_name
         FROM accounts a
         JOIN customers c ON a.customer_id = c.id
         JOIN account_types at ON at.id = a.account_type_id
         WHERE a.id = ?`,[e]);if(!i)throw Error("Account not found");let u=await (0,t.queryOne)(`SELECT 
            COALESCE(SUM(CASE WHEN entry_type = 'CREDIT' THEN amount ELSE 0 END), 0) as total_credits,
            COALESCE(SUM(CASE WHEN entry_type = 'DEBIT' THEN amount ELSE 0 END), 0) as total_debits
         FROM ledger_entries
         WHERE account_id = ? AND entry_date < ?`,[e,r]),d=parseFloat(u?.total_credits||"0")-parseFloat(u?.total_debits||"0"),l=await (0,t.queryOne)(`SELECT COUNT(*) as count
         FROM ledger_entries le
         WHERE le.account_id = ? AND le.entry_date >= ? AND le.entry_date <= ?`,[e,r,n]),p=l?.count||0,_=await (0,t.queryOne)(`SELECT 
            COALESCE(SUM(CASE WHEN entry_type = 'CREDIT' THEN amount ELSE 0 END), 0) as total_credits,
            COALESCE(SUM(CASE WHEN entry_type = 'DEBIT' THEN amount ELSE 0 END), 0) as total_debits
         FROM ledger_entries
         WHERE account_id = ? AND entry_date >= ? AND entry_date <= ?`,[e,r,n]),y=parseFloat(_?.total_credits||"0"),E=parseFloat(_?.total_debits||"0"),m=await (0,t.query)(`SELECT le.id, le.transaction_id, le.account_id, le.entry_type, 
                le.amount, le.currency, le.balance_after, le.description,
                le.entry_date, le.created_at, t.transaction_reference,
                tt.code as transaction_type
         FROM ledger_entries le
         JOIN transactions t ON le.transaction_id = t.id
         JOIN transaction_types tt ON t.transaction_type_id = tt.id
         WHERE le.account_id = ? AND le.entry_date >= ? AND le.entry_date <= ?
         ORDER BY le.created_at ASC, le.id ASC
         LIMIT ? OFFSET ?`,[e,r,n,s,o]),f=d;if(c>1){let a=await (0,t.queryOne)(`SELECT 
                COALESCE(SUM(CASE WHEN entry_type = 'CREDIT' THEN amount ELSE 0 END), 0) as total_credits,
                COALESCE(SUM(CASE WHEN entry_type = 'DEBIT' THEN amount ELSE 0 END), 0) as total_debits
             FROM (
                SELECT entry_type, amount
                FROM ledger_entries
                WHERE account_id = ? AND entry_date >= ? AND entry_date <= ?
                ORDER BY created_at ASC, id ASC
                LIMIT ?
             ) as previous_entries`,[e,r,n,o]);f=d+parseFloat(a?.total_credits||"0")-parseFloat(a?.total_debits||"0")}let N=m.map(e=>{let t=parseFloat(e.amount);return"CREDIT"===e.entry_type?f+=t:f-=t,{id:e.id,date:e.entry_date,description:e.description,debit:"DEBIT"===e.entry_type?t:null,credit:"CREDIT"===e.entry_type?t:null,runningBalance:Math.round(100*f)/100,transactionReference:e.transaction_reference,transactionType:e.transaction_type}});return{statement:{account:{id:i.id,accountNumber:i.account_number,accountType:i.account_type_name,customerName:i.customer_name},period:{from:r,to:n},openingBalance:Math.round(100*d)/100,closingBalance:Math.round(100*(d+y-E))/100,totalDebits:Math.round(100*E)/100,totalCredits:Math.round(100*y)/100,entries:N},total:p}}function s(e){return new Intl.NumberFormat("en-BD",{style:"currency",currency:"BDT",minimumFractionDigits:2}).format(e)}function o(e){return new Intl.DateTimeFormat("en-GB",{day:"2-digit",month:"short",year:"numeric"}).format(new Date(e))}async function i(e,t,i){let{statement:u}=await c(e,{from:t,to:i,page:1,size:1e4}),d=await a.PDFDocument.create(),l=await d.embedFont(r.StandardFonts.Helvetica),p=await d.embedFont(r.StandardFonts.HelveticaBold),_=d.addPage([595.28,841.89]),{width:y,height:E}=_.getSize(),m=E-50,f=()=>(_=d.addPage([595.28,841.89]),m=E-50,_),N=(e,t,a,r=10,c=l,s=(0,n.rgb)(0,0,0))=>{_.drawText(e,{x:t,y:a,size:r,font:c,color:s})};(0,n.rgb)(0,0,0);let O=(0,n.rgb)(.3,.3,.3),b="BNKCORE",T=p.widthOfTextAtSize(b,22);N(b,(y-T)/2,m,22,p),m-=25;let g="Core Banking System",h=l.widthOfTextAtSize(g,10);N(g,(y-h)/2,m,10,l),m-=35;let R="Account Statement",S=p.widthOfTextAtSize(R,16);N(R,(y-S)/2,m,16,p);let A=m-=45;N("Account Holder:",50,m,10,p),N(u.account.customerName,140,m,10,l),N("Account Number:",50,m-=18,10,p),N(u.account.accountNumber,140,m,10,l),N("Account Type:",50,m-=18,10,p),N(u.account.accountType,140,m,10,l),N("Statement Period:",320,A,10,p),N(`${o(new Date(t))} - ${o(new Date(i))}`,410,A,10,l),N("Generated:",320,A-18,10,p),N(o(new Date),410,A-18,10,l),m-=50,_.drawRectangle({x:50,y:m-55,width:y-100,height:65,borderColor:(0,n.rgb)(0,0,0),borderWidth:1});let C=m-20,I=m-45;N("Opening Balance:",65,C,10,p),N(s(u.openingBalance),160,C,10,p),N("Total Credits:",310,C,10,p),N(s(u.totalCredits),400,C,10,p),N("Closing Balance:",65,I,10,p),N(s(u.closingBalance),160,I,10,p),N("Total Debits:",310,I,10,p),N(s(u.totalDebits),400,I,10,p);let D=e=>{_.drawRectangle({x:50,y:e-18,width:y-100,height:25,color:(0,n.rgb)(.9,.9,.9)});let t=e-3;N("Date",55,t,9,p),N("Description",125,t,9,p);let a=(e,t,a,r,n=9,c=p)=>{let s=c.widthOfTextAtSize(e,n);N(e,t+a-s-5,r,n,c)};a("Debit",300,70,t),a("Credit",380,70,t),a("Balance",465,80,t)};D(m-=90),m-=30;let x=(e,t,a,r,n=8,c=l)=>{let s=c.widthOfTextAtSize(e,n);N(e,t+a-s-5,r,n,c)};for(let e of(N(o(new Date(t)),55,m,8,p),N("Opening Balance",125,m,8,p),x(s(u.openingBalance),465,80,m,8,p),m-=18,u.entries)){m<110&&(f(),D(m),m-=30),u.entries.indexOf(e)%2==1&&_.drawRectangle({x:50,y:m-5,width:y-100,height:18,color:(0,n.rgb)(.98,.98,.98)}),N(o(e.date),55,m,8,l,O);let t=e.description||e.transactionType;N(t.length>35?t.substring(0,32)+"...":t,125,m,8,l),e.debit&&x(s(e.debit),300,70,m,8,l),e.credit&&x(s(e.credit),380,70,m,8,l),x(s(e.runningBalance),465,80,m,8,l),m-=18}m<90&&(f(),D(m),m-=30),m-=5,N(o(new Date(i)),55,m,8,p),N("Closing Balance",125,m,8,p),x(s(u.closingBalance),465,80,m,8,p);let w=d.getPages();for(let e=0;e<w.length;e++){let t=w[e],a=`Page ${e+1} of ${w.length} | This is a computer-generated document and does not require signature.`,r=l.widthOfTextAtSize(a,8);t.drawText(a,{x:(y-r)/2,y:30,size:8,font:l,color:(0,n.rgb)(0,0,0)})}let F=await d.save();return Buffer.from(F)}async function u(e){let{from:a,to:r,amountMin:n,amountMax:c,entryType:s,transactionType:o,reference:i,accountId:u,includeReversals:d=!0,page:l=1,size:p=50}=e,_=["1=1"],y=[];a&&(_.push("le.entry_date >= ?"),y.push(a)),r&&(_.push("le.entry_date <= ?"),y.push(r)),void 0!==n&&(_.push("le.amount >= ?"),y.push(n)),void 0!==c&&(_.push("le.amount <= ?"),y.push(c)),s&&(_.push("le.entry_type = ?"),y.push(s)),o&&(_.push("tt.code = ?"),y.push(o)),i&&(_.push("(t.transaction_reference LIKE ? OR le.description LIKE ?)"),y.push(`%${i}%`,`%${i}%`)),u&&(_.push("le.account_id = ?"),y.push(u)),d||_.push("t.status != 'REVERSED'");let E=_.join(" AND "),m=await (0,t.queryOne)(`SELECT COUNT(*) as count
         FROM ledger_entries le
         JOIN transactions t ON le.transaction_id = t.id
         JOIN transaction_types tt ON t.transaction_type_id = tt.id
         JOIN accounts a ON le.account_id = a.id
         WHERE ${E}`,y);return{results:(await (0,t.query)(`SELECT le.id, t.transaction_reference, tt.code as transaction_type,
                le.account_id, a.account_number, le.entry_type, le.amount,
                le.balance_after, le.description, le.entry_date, le.created_at,
                (t.status = 'REVERSED') as is_reversal
         FROM ledger_entries le
         JOIN transactions t ON le.transaction_id = t.id
         JOIN transaction_types tt ON t.transaction_type_id = tt.id
         JOIN accounts a ON le.account_id = a.id
         WHERE ${E}
         ORDER BY le.created_at DESC, le.id DESC
         LIMIT ? OFFSET ?`,[...y,p,(l-1)*p])).map(e=>({id:e.id,transactionReference:e.transaction_reference,transactionType:e.transaction_type,accountId:e.account_id,accountNumber:e.account_number,entryType:e.entry_type,amount:parseFloat(e.amount),balanceAfter:parseFloat(e.balance_after),description:e.description,entryDate:e.entry_date,createdAt:e.created_at,isReversal:!!e.is_reversal})),total:m?.count||0}}function d(e){return["ID,Date,Transaction Ref,Type,Account Number,Entry Type,Amount,Balance After,Description,Is Reversal",...e.map(e=>[e.id,o(e.entryDate),e.transactionReference,e.transactionType,e.accountNumber,e.entryType,e.amount.toFixed(2),e.balanceAfter.toFixed(2),`"${(e.description||"").replace(/"/g,'""')}"`,e.isReversal?"Yes":"No"]).map(e=>e.join(","))].join("\n")}e.s(["generateCsvFromResults",()=>d,"generateStatementPdf",()=>i,"getAccountStatement",()=>c,"searchTransactions",()=>u])},543,e=>{e.v(e=>Promise.resolve().then(()=>e(90727)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__d796064d._.js.map